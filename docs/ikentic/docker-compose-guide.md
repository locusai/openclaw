# IKENTIC Docker Compose Guide

Run OpenClaw with the IKENTIC plugin via Docker Compose. The base file plus mount overlays lets you choose what is bind-mounted:

- **NPM mode** (production) — ephemeral container state (no bind mounts or named volumes)
- **mount-state** — host-mounted OpenClaw config/workspace with installed/cached plugin
- **mount-plugin** — host-mounted plugin source with ephemeral container state
- **mount-all** — host-mounted config/workspace and host-mounted plugin source

## Prerequisites

- [Docker](https://docs.docker.com/get-docker/) (with Docker Compose v2)
- An IKENTIC-compatible Ike instance (OAuth issuer + API backend)

## NPM Mode (Quick Start)

```bash
# 1. Create your environment file (first run only)
cp .env.ikentic.example .env

# 2. Edit .env:
#    - Configure OAuth and API settings for your Ike instance

# 3. Export runtime auth token as a host env var (used for Docker secret mount)
export NODE_AUTH_TOKEN=<github_pat_with_read:packages>

# 4. Build and start
docker compose -f docker-compose.ikentic.yml up --build
```

Base mode is intentionally ephemeral: no bind mounts and no named volumes. If you run `docker compose ... down` and start again, plugin/state will be re-downloaded/re-created.

## Overlay Modes

Use these overlay files with `docker-compose.ikentic.yml`:

```bash
# Host config/workspace mounts only (installed/cached plugin)
docker compose -f docker-compose.ikentic.yml -f docker-compose.ikentic-mount-state.yml up --build

# Host plugin mount only (state in default container volume)
docker compose -f docker-compose.ikentic.yml -f docker-compose.ikentic-mount-plugin.yml up --build

# Host config/workspace + host plugin mounts
docker compose -f docker-compose.ikentic.yml -f docker-compose.ikentic-mount-all.yml up --build
```

## Mount-All Mode (Quick Start)

```bash
# 1. Create your environment file (first run only)
cp .env.ikentic.example .env

# 2. Edit .env:
#    - Set IKENTIC_PLUGIN_HOST_DIR to the path of your local plugin
#      e.g.: IKENTIC_PLUGIN_HOST_DIR=../ike-agents/packages/openclaw-ikentic-plugin
#    - Set OPENCLAW_CONFIG_DIR and OPENCLAW_WORKSPACE_DIR for host-mounted state
#    - Configure OAuth and API settings

# 3. Build and start with both compose files
docker compose -f docker-compose.ikentic.yml -f docker-compose.ikentic-mount-all.yml up --build
```

The local plugin directory is mounted into the container at `IKENTIC_DEV_MOUNT_PATH` (default: `/home/node/.openclaw/extensions/openclaw-ikentic-plugin`). Changes to plugin source on the host are reflected after a container restart.

## Startup Output

Once started, the logs will print a URL with an auth token:

```
============================================================
  OpenClaw + IKENTIC is ready!

  Open in browser:
    http://localhost:18789/#token=<auto-generated-token>
============================================================
```

Open that URL in your browser to access the gateway dashboard.

## Mode Auto-Detection

The entrypoint script (`scripts/docker-ikentic-entrypoint.sh`) auto-detects the mode at each container start:

1. **Mount-plugin / mount-all mode**: Enabled by those overlays and checks for `IKENTIC_DEV_MOUNT_PATH/openclaw.plugin.json`
2. **NPM cached**: Checks for `~/.openclaw/extensions/openclaw-ikentic-plugin/` (present after a previous npm install)
3. **NPM install**: Downloads the plugin from GitHub Packages using `NODE_AUTH_TOKEN`

## Environment Variables

Edit `.env` before starting.

### Plugin Import

| Variable                  | Required         | Description                                                                                                                                                                                                                            |
| ------------------------- | ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `NODE_AUTH_TOKEN`         | NPM mode         | Host environment variable used by compose to provide runtime secret file `/run/secrets/node_auth_token`. Do not inject it into container env.                                                                                          |
| `IKENTIC_NPM_SPEC`        | No               | npm package spec. Defaults to `@locusai/openclaw-ikentic-plugin`. Pin a version with `@locusai/openclaw-ikentic-plugin@1.2.3`.                                                                                                         |
| `IKENTIC_NPM_STREAM`      | No               | Release stream (`stable`, `beta`, `rc`, `dev`). Ignored when `IKENTIC_NPM_SPEC` is set. When set, the entrypoint checks for updates and refreshes only when version/spec changed (requires `/run/secrets/node_auth_token` to refresh). |
| `IKENTIC_PLUGIN_HOST_DIR` | Mount plugin/all | Host path to the local plugin directory. Used with `docker-compose.ikentic-mount-plugin.yml` and `docker-compose.ikentic-mount-all.yml`.                                                                                               |
| `IKENTIC_DEV_MOUNT_PATH`  | No               | Container path where dev plugin source is mounted. Default: `/home/node/.openclaw/extensions/openclaw-ikentic-plugin`.                                                                                                                 |

### OAuth

| Variable                  | Required | Description                                                          |
| ------------------------- | -------- | -------------------------------------------------------------------- |
| `IKE_OAUTH_ISSUER`        | Yes      | OAuth issuer URL. Use `host.docker.internal` for host-local issuers. |
| `IKE_OAUTH_PUBLIC_ISSUER` | Yes      | Public-facing OAuth issuer URL (usually same as above).              |
| `IKE_OAUTH_REDIRECT_URI`  | Yes      | OAuth callback URL for the OpenClaw gateway.                         |
| `IKE_OAUTH_CLIENT_NAME`   | No       | OAuth client display name. Default: `OpenClaw Ikentic Plugin`.       |
| `IKE_OAUTH_SCOPE`         | No       | OAuth scopes. Default: `openid profile email offline_access`.        |

### API & Model

| Variable                | Required | Description                                             |
| ----------------------- | -------- | ------------------------------------------------------- |
| `IKENTIC_API_BASE_URL`  | Yes      | Base URL of the Ikentic/Locus API backend.              |
| `IKENTIC_MODEL_PRIMARY` | No       | Default AI model. Default: `anthropic/claude-opus-4-6`. |

### Gateway

| Variable                 | Default                         | Description                                                                        |
| ------------------------ | ------------------------------- | ---------------------------------------------------------------------------------- |
| `OPENCLAW_GATEWAY_PORT`  | `18789`                         | Port exposed on the host.                                                          |
| `OPENCLAW_GATEWAY_TOKEN` | _(auto-generated)_              | Gateway auth token. Leave empty to auto-generate (printed in logs).                |
| `OPENCLAW_CONFIG_DIR`    | _(required in mount-state/all)_ | Host directory mapped to `/home/node/.openclaw` in mount-state/all mode.           |
| `OPENCLAW_WORKSPACE_DIR` | _(required in mount-state/all)_ | Host directory mapped to `/home/node/.openclaw/workspace` in mount-state/all mode. |
| `IKENTIC_PLUGINS_ALLOW`  | `openclaw-ikentic-plugin`       | Comma-separated plugin allowlist.                                                  |
| `IKENTIC_TOOLS_ALLOW`    | `group:plugins`                 | Comma-separated tool allowlist.                                                    |

## Common Operations

### Start in the background

```bash
docker compose -f docker-compose.ikentic.yml up --build -d
```

### View logs

```bash
docker compose -f docker-compose.ikentic.yml logs -f
```

### Find the access URL (after starting in background)

```bash
docker compose -f docker-compose.ikentic.yml logs | grep "Open in browser"
```

### Stop

```bash
docker compose -f docker-compose.ikentic.yml down
```

With overlays:

- `mount-state` / `mount-all`: plugin install under host-mounted state can survive `down` and restarts, so starts can still succeed without token unless refresh is requested.
- Base / `mount-plugin`: state is ephemeral, so `down` removes container state and a later start may need token-backed download again.

### Full reset (clear all config/session data and cached plugins)

```bash
docker compose -f docker-compose.ikentic.yml down -v
```

### Rebuild after code changes

```bash
docker compose -f docker-compose.ikentic.yml up --build
```

### Force re-download of plugin (NPM mode)

```bash
# Remove the cached install, then start again
docker compose -f docker-compose.ikentic.yml down -v
docker compose -f docker-compose.ikentic.yml up --build
```

## Networking Notes

- **`host.docker.internal`**: Use this hostname in environment variables when referencing services running on the Docker host machine (e.g., a local Ike OAuth issuer). This works out of the box on macOS and Windows. On Linux, the compose file includes the required `extra_hosts` mapping.
- **Port mapping**: The container always listens on port 18789 internally. The `OPENCLAW_GATEWAY_PORT` variable controls which host port is mapped to it.

## Dockerfile Sync Workflow

`Dockerfile.ikentic` is generated from the base `Dockerfile` and should only carry IKENTIC-specific deltas (BuildKit secret auth and `.npmrc` cleanup).

Use these commands from the repo root:

```bash
# Regenerate Dockerfile.ikentic from Dockerfile
bash scripts/sync-ikentic-dockerfile.sh

# Verify Dockerfile.ikentic is still in sync (CI-style check)
bash scripts/check-ikentic-dockerfile-sync.sh
```

Run the sync script whenever the base `Dockerfile` changes. Run the check script before pushing Docker-related changes.

## Troubleshooting

### Container keeps restarting

Check the logs for errors:

```bash
docker compose -f docker-compose.ikentic.yml logs --tail 50
```

Common causes:

- Missing `NODE_AUTH_TOKEN` in NPM mode
- Missing required environment variables in `.env`
- OAuth issuer not reachable from inside the container

### "/run/secrets/node_auth_token is required" error

Export `NODE_AUTH_TOKEN` in the host shell before `docker compose up` so compose can mount secret file `/run/secrets/node_auth_token`. This token needs GitHub `read:packages` scope.

### Browser shows "device identity required"

You need to use the token URL printed in the logs. The gateway requires token auth when bound to LAN. Copy the full URL including the `#token=...` fragment.

### "plugin id mismatch" warnings

These warnings indicate stale legacy plugin state/config. The startup migration should normalize this automatically; if warnings persist, reset plugin state and restart:

```bash
docker compose -f docker-compose.ikentic.yml down -v
docker compose -f docker-compose.ikentic.yml up --build
```

### OAuth callback fails

Make sure `IKE_OAUTH_REDIRECT_URI` uses a hostname that both the browser and the container can reach. If the OAuth issuer runs on the host, use `host.docker.internal` for the issuer URL but make sure the redirect URI is reachable from the browser.

### Mount-plugin/mount-all: plugin changes not reflected

Plugin source changes require a container restart. Run:

```bash
docker compose -f docker-compose.ikentic.yml -f docker-compose.ikentic-mount-plugin.yml restart
```

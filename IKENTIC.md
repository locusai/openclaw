# OpenClaw + IKENTIC Plugin

Run OpenClaw with the IKENTIC plugin via Docker Compose. Two import modes are supported:

- **NPM mode** (production) — plugin installed from GitHub Packages at container startup
- **Dev mode** (development) — local plugin source mounted into the container

## Prerequisites

- [Docker](https://docs.docker.com/get-docker/) (with Docker Compose v2)
- An IKENTIC-compatible Ike instance (OAuth issuer + API backend)

## NPM Mode (Quick Start)

```bash
# 1. Create your environment file
cp .env.ikentic.example .env.ikentic

# 2. Edit .env.ikentic:
#    - Set NODE_AUTH_TOKEN to a GitHub PAT with read:packages scope
#    - Configure OAuth and API settings for your Ike instance

# 3. Build and start
docker compose -f docker-compose.ikentic.yml up --build
```

On first run the plugin is downloaded from GitHub Packages and cached in a Docker volume. Subsequent starts skip the download and use the cached install.

## Dev Mode (Quick Start)

```bash
# 1. Create your environment file
cp .env.ikentic.example .env.ikentic

# 2. Edit .env.ikentic:
#    - Set IKENTIC_PLUGIN_HOST_DIR to the path of your local plugin
#      e.g.: IKENTIC_PLUGIN_HOST_DIR=../ike-agents/packages/openclaw-ikentic-plugin
#    - Configure OAuth and API settings

# 3. Build and start with both compose files
docker compose -f docker-compose.ikentic.yml -f docker-compose.ikentic.dev.yml up --build
```

The local plugin directory is mounted into the container at `/mnt/ikentic-plugin`. Changes to plugin source on the host are reflected after a container restart.

## Startup Output

Once started, the logs will print a URL with an auth token:

```
============================================================
  OpenClaw + IKENTIC is ready!

  Open in browser:
    http://localhost:18789/#token=<auto-generated-token>
============================================================
```

Open that URL in your browser to access the gateway dashboard.

## Mode Auto-Detection

The entrypoint script (`scripts/docker-ikentic-entrypoint.sh`) auto-detects the mode at each container start:

1. **Dev mode**: Checks for `/mnt/ikentic-plugin/openclaw.plugin.json` (present when the dev override compose file mounts a volume)
2. **NPM cached**: Checks for `~/.openclaw/extensions/openclaw-ikentic-plugin/` (present after a previous npm install)
3. **NPM install**: Downloads the plugin from GitHub Packages using `NODE_AUTH_TOKEN`

## Environment Variables

Edit `.env.ikentic` before starting.

### Plugin Import

| Variable                  | Required | Description                                                                                                                    |
| ------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------ |
| `NODE_AUTH_TOKEN`         | NPM mode | GitHub Personal Access Token with `read:packages` scope. Only needed on first install; cached in the Docker volume afterwards. |
| `IKENTIC_NPM_SPEC`        | No       | npm package spec. Defaults to `@locusai/openclaw-ikentic-plugin`. Pin a version with `@locusai/openclaw-ikentic-plugin@1.2.3`. |
| `IKENTIC_PLUGIN_HOST_DIR` | Dev mode | Host path to the local plugin directory. Used only with `docker-compose.ikentic.dev.yml`.                                      |

### OAuth

| Variable                  | Required | Description                                                          |
| ------------------------- | -------- | -------------------------------------------------------------------- |
| `IKE_OAUTH_ISSUER`        | Yes      | OAuth issuer URL. Use `host.docker.internal` for host-local issuers. |
| `IKE_OAUTH_PUBLIC_ISSUER` | Yes      | Public-facing OAuth issuer URL (usually same as above).              |
| `IKE_OAUTH_REDIRECT_URI`  | Yes      | OAuth callback URL for the OpenClaw gateway.                         |
| `IKE_OAUTH_CLIENT_NAME`   | No       | OAuth client display name. Default: `OpenClaw Ikentic Plugin`.       |
| `IKE_OAUTH_SCOPE`         | No       | OAuth scopes. Default: `openid profile email offline_access`.        |

### API & Model

| Variable                | Required | Description                                             |
| ----------------------- | -------- | ------------------------------------------------------- |
| `IKENTIC_API_BASE_URL`  | Yes      | Base URL of the Ikentic/Locus API backend.              |
| `IKENTIC_MODEL_PRIMARY` | No       | Default AI model. Default: `anthropic/claude-opus-4-6`. |

### Gateway

| Variable                 | Default            | Description                                                         |
| ------------------------ | ------------------ | ------------------------------------------------------------------- |
| `OPENCLAW_GATEWAY_PORT`  | `18789`            | Port exposed on the host.                                           |
| `OPENCLAW_GATEWAY_TOKEN` | _(auto-generated)_ | Gateway auth token. Leave empty to auto-generate (printed in logs). |
| `IKENTIC_PLUGINS_ALLOW`  | `ikentic`          | Comma-separated plugin allowlist.                                   |
| `IKENTIC_TOOLS_ALLOW`    | `group:plugins`    | Comma-separated tool allowlist.                                     |

## Common Operations

### Start in the background

```bash
docker compose -f docker-compose.ikentic.yml up --build -d
```

### View logs

```bash
docker compose -f docker-compose.ikentic.yml logs -f
```

### Find the access URL (after starting in background)

```bash
docker compose -f docker-compose.ikentic.yml logs | grep "Open in browser"
```

### Stop

```bash
docker compose -f docker-compose.ikentic.yml down
```

### Full reset (clear all config/session data and cached plugins)

```bash
docker compose -f docker-compose.ikentic.yml down -v
```

### Rebuild after code changes

```bash
docker compose -f docker-compose.ikentic.yml up --build
```

### Force re-download of plugin (NPM mode)

```bash
# Remove the cached install, then start again
docker compose -f docker-compose.ikentic.yml down -v
docker compose -f docker-compose.ikentic.yml up --build
```

## Networking Notes

- **`host.docker.internal`**: Use this hostname in environment variables when referencing services running on the Docker host machine (e.g., a local Ike OAuth issuer). This works out of the box on macOS and Windows. On Linux, the compose file includes the required `extra_hosts` mapping.
- **Port mapping**: The container always listens on port 18789 internally. The `OPENCLAW_GATEWAY_PORT` variable controls which host port is mapped to it.

## Troubleshooting

### Container keeps restarting

Check the logs for errors:

```bash
docker compose -f docker-compose.ikentic.yml logs --tail 50
```

Common causes:

- Missing `NODE_AUTH_TOKEN` in NPM mode
- Missing required environment variables in `.env.ikentic`
- OAuth issuer not reachable from inside the container

### "NODE_AUTH_TOKEN is required" error

Set `NODE_AUTH_TOKEN` in `.env.ikentic` to a GitHub Personal Access Token with `read:packages` scope. This is required for the first plugin install in NPM mode. You can generate one at GitHub > Settings > Developer settings > Personal access tokens.

### Browser shows "device identity required"

You need to use the token URL printed in the logs. The gateway requires token auth when bound to LAN. Copy the full URL including the `#token=...` fragment.

### "plugin id mismatch" warnings

These warnings (`manifest uses "ikentic", entry hints "openclaw-ikentic-plugin"`) are expected and do not affect functionality.

### OAuth callback fails

Make sure `IKE_OAUTH_REDIRECT_URI` uses a hostname that both the browser and the container can reach. If the OAuth issuer runs on the host, use `host.docker.internal` for the issuer URL but make sure the redirect URI is reachable from the browser.

### Dev mode: plugin changes not reflected

Plugin source changes require a container restart. Run:

```bash
docker compose -f docker-compose.ikentic.yml -f docker-compose.ikentic.dev.yml restart
```
